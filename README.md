# 衝突警告システム 仕様書

**バージョン**: 2.0  
**最終更新日**: 2025年1月20日  
**プロジェクト**: arduino_sample - Dual Sensor Collision Warning System

---

## 1. システム概要

### 1.1 目的
デュアル超音波距離センサを用いた衝突警告システム。監視範囲内の物体を検知し、接近距離に応じてLEDで段階的な警告を行う。

### 1.2 特徴
- **デュアルセンサ構成**: 2つのセンサで広範囲をカバー、死角を低減
- **段階的警告**: 接近距離に応じた3段階の警告表示
- **冗長性**: 片方のセンサ故障時も継続動作可能
- **可変監視範囲**: ボリュームで30～300cmの範囲を調整可能

---

## 2. ハードウェア仕様

### 2.1 使用部品

| 部品名 | 型番/仕様 | 数量 | 用途 |
|:---|:---|:---:|:---|
| マイコン | Arduino Uno/Mega | 1 | システム制御 |
| 超音波センサ | HC-SR04 | 2 | 距離測定 |
| LED（緑） | 5mm | 1 | 監視状態表示 |
| LED（赤） | 5mm | 1 | 警告表示 |
| LED（黄） | 5mm | 1 | 故障通知/拡張用 |
| ボリューム | 10kΩ可変抵抗 | 1 | 監視範囲調整 |
| プッシュボタン | タクトスイッチ | 1 | 開始/停止トグル |
| 抵抗 | 220Ω | 3 | LED電流制限 |
| 抵抗 | 10kΩ | 1 | ボタンプルアップ（オプション） |

### 2.2 ピン配置

| 機能 | Arduino ピン | 信号方向 | 備考 |
|:---|:---:|:---:|:---|
| センサ1 TRIG | 8 | OUT | 超音波送信トリガー |
| センサ1 ECHO | 9 | IN | 超音波受信 |
| センサ2 TRIG | 4 | OUT | 超音波送信トリガー |
| センサ2 ECHO | 5 | IN | 超音波受信 |
| LED 緑 | 11 | OUT | 監視状態表示 |
| LED 赤 | 10 | OUT | 警告表示（PWM対応） |
| LED 黄 | 6 | OUT | 故障通知（PWM対応） |
| ボリューム | A0 | IN | アナログ入力 |
| トグルボタン | 13 | IN | デジタル入力（内部PULLUP） |

### 2.3 配線図（概要）

```
センサ1 (HC-SR04)
  VCC  --> 5V
  TRIG --> Pin 8
  ECHO --> Pin 9
  GND  --> GND

センサ2 (HC-SR04)
  VCC  --> 5V
  TRIG --> Pin 4
  ECHO --> Pin 5
  GND  --> GND

LED制御
  Pin 11 --> [220Ω] --> 緑LED --> GND
  Pin 10 --> [220Ω] --> 赤LED --> GND
  Pin 6  --> [220Ω] --> 黄LED --> GND

ボリューム
  端子1 --> 5V
  端子2 --> Pin A0
  端子3 --> GND

ボタン
  端子1 --> Pin 13 (内部PULLUP有効)
  端子2 --> GND
```

---

## 3. ソフトウェア仕様

### 3.1 システム構成

```
arduino_sample/
├── arduino_sample.ino           # メインスケッチ
├── arduino_sample.h             # 統合ヘッダーファイル
├── DistanceSensor.cpp           # 距離センサクラス実装
├── LedController.cpp            # LED制御クラス実装
├── VolumeController.cpp         # ボリューム制御クラス実装
├── ButtonController.cpp         # ボタン制御クラス実装
└── CollisionWarningSystem.cpp   # システム統合クラス実装
```

### 3.2 クラス設計

#### 3.2.1 DistanceSensor クラス

**責務**: 超音波距離センサの制御と故障検知

**主要メソッド**:
- `begin()`: センサ初期化
- `getDistance()`: 距離測定（cm単位）
- `isFaulty()`: 故障判定
- `resetErrorCount()`: エラーカウントリセット

**動作仕様**:
- 測定範囲: 2～400cm
- 測定精度: ±1cm
- 故障判定閾値: 連続10回の異常値

#### 3.2.2 LedController クラス

**責務**: 3つのLEDの制御

**主要メソッド**:
- `begin()`: LED初期化
- `setMonitoringActive(bool)`: 緑LED制御
- `setWarningLevel(level, distance, range)`: 警告レベル設定
- `updateBlink()`: 点滅更新
- `displayFault()`: 故障通知（黄LED点滅）
- `turnOffAll()`: 全LED消灯

**警告レベル**:
```cpp
enum WarningLevel {
    OFF = 0,           // 消灯
    SLOW_BLINK = 1,    // 低速点滅（500ms）
    FAST_BLINK = 2,    // 高速点滅（200ms）
    SOLID = 3          // 常時点灯
};
```

#### 3.2.3 VolumeController クラス

**責務**: ボリュームからの監視範囲設定値取得

**主要メソッド**:
- `begin()`: 初期化
- `getMonitoringRange()`: 監視範囲取得（30～300cm）

**マッピング**:
- アナログ値 0 → 30cm
- アナログ値 1023 → 300cm

#### 3.2.4 ButtonController クラス

**責務**: ボタン入力処理（デバウンス・トグル）

**主要メソッド**:
- `begin()`: 初期化
- `isPressed()`: 押下状態取得
- `wasToggled()`: トグル検出
- `getToggleState()`: 現在のトグル状態

**デバウンス時間**: 50ms

#### 3.2.5 CollisionWarningSystem クラス

**責務**: システム全体の統合制御

**主要メソッド**:
- `begin()`: システム初期化
- `update()`: メインループ処理
- `toggleSystem()`: 監視開始/停止切替
- `getMinDistance(dist1, dist2)`: 最短距離取得

---

## 4. 機能仕様

### 4.1 動作モード

#### 4.1.1 停止モード
- 全LED消灯
- センサ測定停止
- ボタン監視のみ実行

#### 4.1.2 監視モード
- 緑LED常時点灯
- センサ測定実行
- 監視範囲外: 赤LED消灯
- 監視範囲内: 警告表示

#### 4.1.3 警告モード
- 緑LED常時点灯
- 赤LED表示（距離に応じて変化）

#### 4.1.4 故障モード
- 黄LED点滅（500ms間隔）
- 監視継続（可能な場合）

### 4.2 警告アルゴリズム

```
監視範囲 = ボリューム設定値 (30-300cm)
検知距離 = min(センサ1距離, センサ2距離)

if 検知距離 > 監視範囲:
    赤LED: 消灯
    
elif 検知距離 <= 監視範囲 × 0.25:
    赤LED: 常時点灯（近距離警告）
    
elif 検知距離 <= 監視範囲 × 0.5:
    赤LED: 高速点滅 200ms間隔（中距離警告）
    
else:
    赤LED: 低速点滅 500ms間隔（遠距離警告）
```

### 4.3 センサ故障検知

#### 故障判定条件
- 連続10回以上の異常値検出
- 異常値: 2cm未満 または 400cm超過

#### 故障時の動作
- **片方故障**: 正常なセンサで継続動作
- **両方故障**: 黄LED点滅、監視停止

---

## 5. 処理フロー

### 5.1 メインフロー

```mermaid
flowchart TD
    A[システム起動] --> B[初期化]
    B --> C[メインループ開始]
    C --> D{ボタントグル?}
    D -- Yes --> E{現在の状態}
    E -- 停止中 --> F[監視開始・緑LED点灯]
    E -- 稼働中 --> G[監視停止・全LED消灯]
    D -- No --> H{システム稼働中?}
    H -- No --> C
    H -- Yes --> I[ボリューム値取得]
    I --> J[監視範囲設定]
    J --> K[センサ1距離取得]
    K --> L[センサ2距離取得]
    L --> M{両センサ故障?}
    M -- Yes --> N[故障カウント+1]
    N --> O{閾値到達?}
    O -- Yes --> P[黄LED点滅]
    P --> C
    O -- No --> Q[最短距離選択]
    M -- No --> Q
    Q --> R{有効な距離?}
    R -- No --> S[赤LED消灯]
    S --> C
    R -- Yes --> T[警告レベル判定]
    T --> U{距離 ≤ 範囲×0.25?}
    U -- Yes --> V[赤LED常時点灯]
    U -- No --> W{距離 ≤ 範囲×0.5?}
    W -- Yes --> X[赤LED高速点滅]
    W -- No --> Y{距離 ≤ 範囲?}
    Y -- Yes --> Z[赤LED低速点滅]
    Y -- No --> S
    V --> C
    X --> C
    Z --> C
```

### 5.2 センサ測定フロー

```mermaid
flowchart TD
    A[測定開始] --> B[TRIG LOW 2μs]
    B --> C[TRIG HIGH 10μs]
    C --> D[TRIG LOW]
    D --> E[ECHO パルス幅測定]
    E --> F[距離計算: duration×0.034/2]
    F --> G{2cm ≤ 距離 ≤ 400cm?}
    G -- Yes --> H[エラーカウントリセット]
    H --> I[距離を返す]
    G -- No --> J[エラーカウント+1]
    J --> K{カウント ≥ 10?}
    K -- Yes --> L[故障フラグON]
    K -- No --> M[-1を返す]
    L --> M
```

---

## 6. データ仕様

### 6.1 定数定義

| 定数名 | 値 | 単位 | 説明 |
|:---|---:|:---:|:---|
| 最小監視範囲 | 30 | cm | ボリューム最小値 |
| 最大監視範囲 | 300 | cm | ボリューム最大値 |
| センサ最小距離 | 2 | cm | 測定可能最小距離 |
| センサ最大距離 | 400 | cm | 測定可能最大距離 |
| 故障判定閾値 | 10 | 回 | 連続異常値回数 |
| デバウンス時間 | 50 | ms | ボタンデバウンス |
| 低速点滅間隔 | 500 | ms | 遠距離警告 |
| 高速点滅間隔 | 200 | ms | 中距離警告 |
| 故障点滅間隔 | 500 | ms | 黄LED点滅 |

### 6.2 状態変数

| 変数名 | 型 | 初期値 | 説明 |
|:---|:---|:---|:---|
| systemRunning | bool | false | システム稼働状態 |
| monitoringRange | long | 150 | 現在の監視範囲（cm） |
| currentLevel | WarningLevel | OFF | 現在の警告レベル |
| toggleState | bool | false | ボタントグル状態 |
| faultCounter | int | 0 | 故障検出カウンタ |

---

## 7. シリアル通信仕様

### 7.1 通信設定
- ボーレート: 9600 bps
- データビット: 8
- パリティ: なし
- ストップビット: 1

### 7.2 出力フォーマット

#### 初期化時
```
=================================
Collision Warning System Initialized
Dual Sensor Configuration
Press button to toggle monitoring
=================================
```

#### システム開始時
```
>>> System STARTED <<<
```

#### システム停止時
```
>>> System STOPPED <<<
```

#### 通常動作時（100ms間隔）
```
Range: 150 cm | S1: 85 cm | S2: 92 cm | Min: 85 cm
```

#### 故障検知時
```
FAULT: Both sensors failed!
```

**出力項目説明**:
- `Range`: 現在の監視範囲設定値
- `S1`: センサ1の測定距離（ERR=異常値）
- `S2`: センサ2の測定距離（ERR=異常値）
- `Min`: 採用された最短距離

---

## 8. 性能仕様

### 8.1 タイミング仕様

| 項目 | 値 | 備考 |
|:---|---:|:---|
| メインループ周期 | 100 | ms |
| センサ測定周期 | 100 | ms（メインループに同期） |
| センサ測定時間 | 約30 | ms（最大） |
| LED更新周期 | 可変 | 点滅パターンに依存 |
| ボタン応答時間 | < 150 | ms（デバウンス含む） |

### 8.2 精度仕様

| 項目 | 仕様 |
|:---|:---|
| 距離測定精度 | ±1 cm（HC-SR04仕様） |
| 監視範囲設定分解能 | 約0.26 cm/step（270cm÷1024） |
| 応答時間 | < 200 ms |

---

## 9. 使用方法

### 9.1 初期セットアップ
1. ハードウェアを仕様通りに配線
2. Arduino IDEでスケッチを開く
3. ボードとポートを選択
4. コンパイル・アップロード

### 9.2 基本操作
1. シリアルモニタを開く（9600 bps）
2. トグルボタンを1回押す → 監視開始（緑LED点灯）
3. ボリュームを回して監視範囲を調整
4. 物体を近づけると赤LEDが点滅/点灯
5. トグルボタンを再度押す → 監視停止（全LED消灯）

### 9.3 動作確認項目
- [ ] 緑LED: ボタン押下で点灯/消灯
- [ ] 赤LED: 距離に応じて消灯→低速点滅→高速点滅→点灯
- [ ] 黄LED: センサ故障時に点滅
- [ ] ボリューム: 監視範囲が変化
- [ ] シリアル出力: 距離情報が正しく表示

---

## 10. トラブルシューティング

### 10.1 よくある問題

| 症状 | 原因 | 対処方法 |
|:---|:---|:---|
| センサが反応しない | 配線ミス | ピン配置を確認 |
| 距離が不安定 | センサ設置角度 | センサを水平に設置 |
| LEDが点灯しない | 抵抗値/配線 | 220Ω抵抗を確認 |
| ボタンが反応しない | 配線/PULLUP設定 | Pin13の配線確認 |
| 黄LEDが常に点滅 | センサ故障 | センサ動作確認 |
| 監視範囲が変化しない | ボリューム配線 | A0ピン配線確認 |

### 10.2 デバッグ方法
1. シリアルモニタで出力を確認
2. 各センサ値が正常に取得されているか確認
3. `ERR`表示がある場合は該当センサの配線確認
4. ボリューム値が変化しているか確認（Range値）

---

## 11. 拡張仕様（将来対応）

### 11.1 黄LED活用案
- 警告レベル中間表示（緑→黄→赤の3段階）
- 複数物体検知時の表示
- 設定モード表示

### 11.2 機能拡張案
- ブザー追加による音声警告
- 複数監視範囲設定（プリセット）
- ログ記録機能
- 無線通信による遠隔監視
- センサ角度調整機構

---

## 12. 変更履歴

| バージョン | 日付 | 変更内容 |
|:---:|:---|:---|
| 2.0 | 2025-01-20 | デュアルセンサ構成に変更、LED構成変更、トグルボタン方式採用 |
| 1.0 | 2025-01-20 | 初版リリース（シングルセンサ、RGBコンフィグ） |

---

## 13. 参考資料

- [Arduino公式リファレンス](https://www.arduino.cc/reference/en/)
- [HC-SR04データシート](https://cdn.sparkfun.com/datasheets/Sensors/Proximity/HCSR04.pdf)
- プロジェクトリポジトリ: arduino_sample

---

**作成者**: GitHub Copilot  
**承認者**: -  
**文書管理番号**: SPEC-002-2025

---

©2024-2025 Mamezo Co.,Ltd.
